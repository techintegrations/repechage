<div class="sample-product-wrapper custom-dots-style" data-max-products="{{ settings.max_products }}">
  {% if settings.heading != blank or settings.text != blank %}
    <div class="top-heading">
      {% if settings.heading != blank %}
        <h2>{{ settings.heading }}</h2>
      {% endif %}
      {% if settings.text != blank %}
        <h4>{{ settings.text }}</h4>
      {% endif %}
    </div>
  {% endif %}

  {% assign cart_total_dollars = cart.total_price | divided_by: 100 %}
  {% assign required_amount = settings.amount | times: 1 %}
  {% if cart_total_dollars > required_amount %}
    <div class="sample-product-row premium-product {% if settings.premium_products.size > 4 %}sample-product-slider{% endif %}">
      {% for Pproduct in settings.premium_products %}
        <div class="sample-product">
          <div class="f-image">
            <img src="{{ Pproduct.featured_image | img_url:'300x' }}">
          </div>
          <div class="grid-product__info">
            <div class="grid-product__title grid-product__title--body">{{ Pproduct.title }}</div>
            {% assign current_variant = Pproduct.selected_or_first_available_variant %}
            <button type="button" {% unless current_variant.available %}disabled="disabled"{% endunless %} class="btn btn--full add-to-cart-btn" data-variant-id="{{current_variant.id}}">
              {% if current_variant.available %}
                {{ 'products.product.add_to_cart' | t }}
              {% else %}
                {{ 'products.product.sold_out' | t }}
              {% endif %}
            </button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="sample-product-row simple-product">
      {% for Sproduct in settings.sample_products %}
        <div class="sample-product">
          <div class="f-image">
            <img src="{{ Sproduct.featured_image | img_url:'300x' }}">
          </div>
          <div class="grid-product__info">
            <div class="grid-product__title grid-product__title--body">{{ Sproduct.title }}</div>
            {% assign current_variant = Sproduct.selected_or_first_available_variant %}
            <button type="button" {% unless current_variant.available %}disabled="disabled"{% endunless %} class="btn btn--full add-to-cart-btn" data-variant-id="{{current_variant.id}}">
              {% if current_variant.available %}
                {{ 'products.product.add_to_cart' | t }}
              {% else %}
                {{ 'products.product.sold_out' | t }}
              {% endif %}
            </button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
  {% assign maxProducts = settings.max_products %}
  <p class="max-samples-message" style="display:none;">{{ settings.max_product_message | replace: '[number]', maxProducts }}</p>
  <div class="sample-checkout-wrap">
    <button type="button" class="btn btn--full popup-checkout-btn">Checkout</button>
    <button data-fancybox data-src="#cart-sample-product">No Thanks</button>
  </div>
</div>

<script>
  var selectedProducts = [];
  var maxProducts = document.querySelector('.sample-product-wrapper').getAttribute('data-max-products');

  function toggleProduct(variantId, button) {
    if (selectedProducts.includes(variantId)) {
      selectedProducts = selectedProducts.filter(id => id !== variantId);
      button.textContent = '{{ "products.product.add_to_cart" | t }}';
      button.classList.remove('remove-btn');
    } else {
      if (selectedProducts.length < maxProducts) {
        selectedProducts.push(variantId);
        button.textContent = 'Remove';
        button.classList.add('remove-btn');
      } else {
        alert('You can only add up to ' + maxProducts + ' products.');
      }
    }
    document.querySelector('.max-samples-message').style.display = selectedProducts.length == maxProducts ? 'block' : 'none';
  }

  document.querySelectorAll('.add-to-cart-btn').forEach(button => {
    button.addEventListener('click', () => {
      var variantId = button.getAttribute('data-variant-id');
      toggleProduct(variantId, button);
    });
  });

  document.querySelector('.popup-checkout-btn').addEventListener('click', () => {
    console.log('Checkout button clicked'); // Debugging information
    if (selectedProducts.length === 0) {
      alert('No products selected for checkout.');
      return;
    }

    function addProductToCart(index) {
      if (index >= selectedProducts.length) {
        console.log('All products added to cart');
        window.location.href = '/checkout'; // Redirect to checkout page
        return;
      }

      var variantId = selectedProducts[index];
      console.log('Adding product with variant ID: ' + variantId); // Debugging information
      var ajax = {
        type: "POST",
        url: "/cart/add.js",
        data: "quantity=1&id=" + variantId,
        dataType: "json",
        success: function (n) {
          console.log('Product added to cart: ' + variantId); // Debugging information
          addProductToCart(index + 1); // Add next product
        },
        error: function (n, c) {
          console.log('Failed to add product to cart: ' + variantId); // Debugging information
          addProductToCart(index + 1); // Try to add next product even if this one fails
        }
      };
      jQuery.ajax(ajax);
    }

    addProductToCart(0); // Start adding products from the first one
  });
</script>

<style>
  .remove-btn {
      background-color: #ff4b4b;
  }
  
  .remove-btn:hover, .remove-btn:focus {
      background-color: #ff0000;
  }
  p.max-samples-message {
    text-align: center;
    margin: 15px 0;
    color: #ff4b4b;
  }
  
  .sample-product-row {
      min-height: 420px;
      padding-bottom: 15px;
  }
  
  .sample-product-row ol.flickity-page-dots {
      position: relative;
  }
</style>